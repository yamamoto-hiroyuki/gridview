<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title></title>
</head>
<body>
	<div id="controls">
		<input type="file" id="file">
		<input type="button" id="show" value="show">
		<input type="number" id="colors" value="7" min="2" max="15"><input type="button" id="posterize" value="posterize">
	</div>
	<canvas id="canvas"></canvas>
<script src="https://code.jquery.com/jquery-1.12.4.js"></script>
<script>
$(document).ready(function () {
	var posterize = function (imageData, colors) {
		var levels = new Array(256);
		for (var i = 0; i < colors; i++) {
			levels.fill(256 / colors * i, 256 / colors * i, 256 / colors * (i + 1));
		}
		levels.fill(256 / colors * (colors - 1), 256 / colors * (colors - 1), 256);
		for (var i = 0; i < imageData.data.length; i += 4) {
			imageData.data[i] = levels[imageData.data[i]];
			imageData.data[i + 1] = levels[imageData.data[i + 1]];
			imageData.data[i + 2] = levels[imageData.data[i + 2]];
		}
	};
	var file = document.getElementById("file");
	var canvas = document.getElementById("canvas");
	var colors = document.getElementById("colors");
	var image = new Image();
	var savedImageData = null;	// we may use context.save()/restore().
	$("#show").on("click", function (event) {
		var reader = new FileReader();
		reader.onload = function (event1) {
			image.onload = function () {
				$(canvas).prop({
						"width": image.width,
						"height": image.height});
				var context = canvas.getContext("2d");
				context.clearRect(0, 0, image.width, image.height);
				context.drawImage(image, 0, 0);
				savedImageData = context.getImageData(0, 0, image.width, image.height);
			};
			image.src = event1.target.result;
		};
		reader.readAsDataURL(file.files[0]);
	});
	var cloneImageData = function (source) {
		return new ImageData(
			new Uint8ClampedArray(source.data),
			image.width, image.height);
	};
	$("#posterize").on("click", function (event) {
		var imageData = cloneImageData(savedImageData);
		posterize(imageData, colors.value);
		canvas.getContext("2d").putImageData(imageData, 0, 0);
	});
});
</script>
</body>
</html>
